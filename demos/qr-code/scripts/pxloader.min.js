/**
 * PixelLab Resource Loader
 * Loads resources while providing progress updates.
 */
 
function PxLoader(settings){settings=settings||{},settings.statusInterval==null&&(settings.statusInterval=5e3),settings.loggingDelay==null&&(settings.loggingDelay=2e4),settings.noProgressTimeout==null&&(settings.noProgressTimeout=Infinity);var entries=[],progressListeners=[],timeStarted,progressChanged=+(new Date),ResourceState={QUEUED:0,WAITING:1,LOADED:2,ERROR:3,TIMEOUT:4},ensureArray=function(val){return val==null?[]:Array.isArray(val)?val:[val]};this.add=function(resource){resource.tags=ensureArray(resource.tags),resource.priority==null&&(resource.priority=Infinity),entries.push({resource:resource,state:ResourceState.QUEUED})},this.addProgressListener=function(callback,tags){progressListeners.push({callback:callback,tags:ensureArray(tags)})},this.addCompletionListener=function(callback,tags){progressListeners.push({tags:ensureArray(tags),callback:function(e){e.completedCount===e.totalCount&&callback()}})};var getResourceSort=function(orderedTags){orderedTags=ensureArray(orderedTags);var getTagOrder=function(entry){var resource=entry.resource,bestIndex=Infinity;for(var i=0,len=resource.tags.length;i<len;i++){var index=orderedTags.indexOf(resource.tags[i]);index>=0&&index<bestIndex&&(bestIndex=index)}return bestIndex};return function(a,b){var aOrder=getTagOrder(a),bOrder=getTagOrder(b);return aOrder<bOrder?-1:aOrder>bOrder?1:a.priority<b.priority?-1:a.priority>b.priority?1:0}};this.start=function(orderedTags){timeStarted=+(new Date);var compareResources=getResourceSort(orderedTags);entries.sort(compareResources);for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];entry.status=ResourceState.WAITING,entry.resource.start(this)}setTimeout(statusCheck,100)};var statusCheck=function(){var checkAgain=!1,noProgressTime=+(new Date)-progressChanged,timedOut=noProgressTime>=settings.noProgressTimeout,shouldLog=noProgressTime>=settings.loggingDelay;for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];if(entry.status!==ResourceState.WAITING)continue;entry.resource.checkStatus(),entry.status===ResourceState.WAITING&&(timedOut?entry.resource.onTimeout():checkAgain=!0)}shouldLog&&checkAgain&&log(),checkAgain&&setTimeout(statusCheck,settings.statusInterval)};this.isBusy=function(){for(var i=0,len=entries.length;i<len;i++)if(entries[i].status===ResourceState.QUEUED||entries[i].status===ResourceState.WAITING)return!0;return!1};var arraysIntersect=function(a,b){for(var i=0,len=a.length;i<len;i++)if(b.indexOf(a[i])>=0)return!0;return!1},onProgress=function(resource,statusType){var entry=null;for(var i=0,len=entries.length;i<len;i++)if(entries[i].resource===resource){entry=entries[i];break}if(entry==null||entry.status!==ResourceState.WAITING)return;entry.status=statusType,progressChanged=+(new Date);var numResourceTags=resource.tags.length;for(var i=0,numListeners=progressListeners.length;i<numListeners;i++){var listener=progressListeners[i],shouldCall;listener.tags.length===0?shouldCall=!0:shouldCall=arraysIntersect(resource.tags,listener.tags),shouldCall&&sendProgress(entry,listener)}};this.onLoad=function(resource){onProgress(resource,ResourceState.LOADED)},this.onError=function(resource){onProgress(resource,ResourceState.ERROR)},this.onTimeout=function(resource){onProgress(resource,ResourceState.TIMEOUT)};var sendProgress=function(updatedEntry,listener){var completed=0,total=0;for(var i=0,len=entries.length;i<len;i++){var entry=entries[i],includeResource;listener.tags.length===0?includeResource=!0:includeResource=arraysIntersect(entry.resource.tags,listener.tags),includeResource&&(total++,(entry.status===ResourceState.LOADED||entry.status===ResourceState.ERROR||entry.status===ResourceState.TIMEOUT)&&completed++)}listener.callback({resource:updatedEntry.resource,loaded:updatedEntry.status===ResourceState.LOADED,error:updatedEntry.status===ResourceState.ERROR,timeout:updatedEntry.status===ResourceState.TIMEOUT,completedCount:completed,totalCount:total})},log=this.log=function(showAll){if(!window.console)return;var elapsedSeconds=Math.round((+(new Date)-timeStarted)/1e3);window.console.log("PxLoader elapsed: "+elapsedSeconds+" sec");for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];if(!showAll&&entry.status!==ResourceState.WAITING)continue;var message="PxLoader: #"+i+" "+entry.resource.getName();switch(entry.status){case ResourceState.QUEUED:message+=" (Not Started)";break;case ResourceState.WAITING:message+=" (Waiting)";break;case ResourceState.LOADED:message+=" (Loaded)";break;case ResourceState.ERROR:message+=" (Error)";break;case ResourceState.TIMEOUT:message+=" (Timeout)"}entry.resource.tags.length>0&&(message+=" Tags: ["+entry.resource.tags.join(",")+"]"),window.console.log(message)}}}Array.isArray||(Array.isArray=function(arg){return Object.prototype.toString.call(arg)=="[object Array]"}),Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement){"use strict";if(this==null)throw new TypeError;var t=Object(this),len=t.length>>>0;if(len===0)return-1;var n=0;arguments.length>0&&(n=Number(arguments[1]),n!=n?n=0:n!=0&&n!=Infinity&&n!=-Infinity&&(n=(n>0||-1)*Math.floor(Math.abs(n))));if(n>=len)return-1;var k=n>=0?n:Math.max(len-Math.abs(n),0);for(;k<len;k++)if(k in t&&t[k]===searchElement)return k;return-1});function PxLoaderImage(url,tags,priority){var self=this,loader=null;this.img=new Image,this.tags=tags,this.priority=priority;var onReadyStateChange=function(){self.img.readyState=="complete"&&(removeEventHandlers(),loader.onLoad(self))},onLoad=function(){removeEventHandlers(),loader.onLoad(self)},onError=function(){removeEventHandlers(),loader.onError(self)},removeEventHandlers=function(){self.unbind("load",onLoad),self.unbind("readystatechange",onReadyStateChange),self.unbind("error",onError)};this.start=function(pxLoader){loader=pxLoader,self.bind("load",onLoad),self.bind("readystatechange",onReadyStateChange),self.bind("error",onError),self.img.src=url},this.checkStatus=function(){self.img.complete&&(removeEventHandlers(),loader.onLoad(self))},this.onTimeout=function(){removeEventHandlers(),self.img.complete?loader.onLoad(self):loader.onTimeout(self)},this.getName=function(){return url},this.bind=function(eventName,eventHandler){self.img.addEventListener?self.img.addEventListener(eventName,eventHandler,!1):self.img.attachEvent&&self.img.attachEvent("on"+eventName,eventHandler)},this.unbind=function(eventName,eventHandler){self.img.removeEventListener?self.img.removeEventListener(eventName,eventHandler,!1):self.img.detachEvent&&self.img.detachEvent("on"+eventName,eventHandler)}}PxLoader.prototype.addImage=function(url,tags,priority){var imageLoader=new PxLoaderImage(url,tags,priority);return this.add(imageLoader),imageLoader.img};